# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**ze** (Zig Editor / Zero-latency Editor) は、mgとUnix哲学に影響を受けた、高速で最小限のテキストエディタです。Zigで実装され、Emacsキーバインディングとシェル統合を特徴とします。

## 開発状態

現在は設計・初期実装フェーズ（Phase 1）です。README.mdに詳細な設計書があります。

**重要**: このプロジェクトは未リリースの開発初期段階です。以下の方針で開発してください：

- **破壊的変更OK**: 後方互換性は一切考慮不要です
- **大胆なリファクタリング歓迎**: より良い設計があれば躊躇なく全面的に書き直してください
- **パフォーマンス優先**: 正しさとパフォーマンスのためなら、既存コードを完全に捨てて構いません
- **API変更自由**: 関数シグネチャ、構造体レイアウト、全て自由に変更可能です

## ビルドとテスト

```bash
# ビルド
zig build

# リリースビルド（最適化）
zig build -Doptimize=ReleaseFast

# テスト実行
zig build test

# 実行
./zig-out/bin/ze [file]
```

## アーキテクチャの要点

### コアデータ構造

1. **Buffer (buffer.zig)**: Piece Table + B-tree
   - 元ファイルはmmap（読み取り専用、ゼロコピー）
   - 追加バッファはArenaアロケータ（フラグメンテーションなし）
   - B-treeで行番号→pieceオフセットの索引（遅延、オンデマンド）

2. **View (view.zig)**: ダブルバッファセル、差分のみレンダリング
   - フロント/バックバッファを使用
   - 変更されたセルのみ出力（差分レンダリング）
   - 1フレームあたり1回のwrite()システムコール

3. **Input (input.zig)**: 専用入力スレッド
   - epoll/kqueue使用
   - ロックフリーキューでメインスレッドと通信
   - 投機的レンダリング：文字入力時に即座に描画してからバッファ更新

4. **Search (search.zig)**: SIMD検索エンジン
   - リテラル検索にSIMD命令使用
   - 1MBチャンクに分割して並列検索
   - インクリメンタル検索対応

### パフォーマンス目標

| 指標 | 目標値 |
|------|--------|
| 起動時間 | < 10ms |
| キー入力から画面更新 | < 8ms (125fps) |
| ファイルオープン (1GB) | < 100ms |
| 検索速度 (1GB) | > 2GB/s |
| メモリオーバーヘッド | ファイルサイズの約10% |

## コマンドシステム

### 文法

```
command := source? pipe* sink?
```

### ソース指定子

- `.` または `%`: バッファ全体
- `,`: 選択範囲
- `;`: 現在行
- `n,m`: 行範囲
- `@x`: レジスタx

### シンク指定子

- `.`: バッファ置換
- `,`: 選択範囲置換
- `+`: カーソル位置に挿入
- `_`: 破棄
- `@x`: レジスタxに保存
- `new`, `vs`, `sp`: 新規バッファ/分割

### 例

```
, | sort > .          # 選択範囲をソートしてバッファに置換
; | sh > +            # 現在行をシェル実行して下に挿入
. | grep TODO         # バッファをgrepして新規バッファに
, | jq . > ,          # 選択範囲をjqでフォーマット
```

## 実装の優先順位

Phase 1（現在）では以下を実装：
- Piece tableバッファ
- 基本レンダリング
- Emacs移動キー（C-f, C-b, C-n, C-p, C-a, C-e等）
- 挿入/削除
- ファイルI/O

## コーディングガイドライン

### 基本原則

- **パフォーマンス最優先**: 8ms以内の応答性を維持
- **ゼロコピー**: 可能な限りmmapとスライスを使用
- **comptime活用**: キーマップテーブル等はコンパイル時に解決
- **アロケーション最小化**: Arena/固定バッファ使用
- **SIMD最適化**: 検索等の高速化にSIMD命令を活用
- **シンプルさ**: Unix哲学に従い、1つのことを上手く行う

### 「あるべき姿」の追求

このプロジェクトでは、機能の理論的に最適な実装（「あるべき姿」）を追求します：

- **最適化の妥協を避ける**: 「十分速い」ではなく「理論的に最速」を目指す
- **段階的な改善**: まず動くものを作り、次に最適化する（premature optimizationは避ける）
- **複雑さとのバランス**: ただし以下の場合は「あるべき姿」を諦める
  - コードが極端に複雑になる（理解困難、保守困難）
  - コード量が2倍以上になる
  - 実測で効果が10%未満

#### 実装例：セルレベル差分描画

「行単位の差分描画」から「セルレベル差分描画」への改善：
- 前フレームの画面状態を保持（メモリコスト: 数KB）
- バイト単位で差分検出して変更部分のみ描画
- **効果**: ターミナル出力量40-90%削減、体感できる速度向上
- **複雑さ**: 許容範囲（約100行の追加、ロジックは明快）
- **結論**: 実装すべき ✅

このように、効果が明確で複雑さが許容範囲なら、積極的に「あるべき姿」を実装してください。

## ファイル構造

```
ze/
├── src/
│   ├── main.zig          # エントリポイント
│   ├── editor.zig        # エディタコア状態
│   ├── buffer.zig        # Piece table実装
│   ├── view.zig          # レンダリング、画面管理
│   ├── input.zig         # 入力処理、キーパース
│   ├── command.zig       # コマンドパーサー、実行器
│   ├── search.zig        # 検索エンジン (SIMD)
│   ├── terminal.zig      # 端末制御
│   ├── window.zig        # ウィンドウ/分割管理
│   ├── keymap.zig        # キーバインディング定義
│   ├── builtin.zig       # 組み込みコマンド
│   ├── pipe.zig          # パイプライン実行
│   └── util/
│       ├── arena.zig     # Arenaアロケータ
│       ├── btree.zig     # B-tree索引
│       ├── queue.zig     # ロックフリーキュー
│       └── simd.zig      # SIMDユーティリティ
├── build.zig
├── README.md
└── config/
    └── default.zig       # デフォルト設定、エイリアス
```

## 非目標

以下は実装しない（v1では）：
- シンタックスハイライト
- LSP統合
- プラグインシステム
- マウスサポート
- GUI
